# ALNS优化效果测试

本目录包含三个专门用于展示ALNS优化效果的测试文件，分别对应小、中、大三种规模场景。

---

## 📁 测试文件

| 文件 | 规模 | 任务数 | 充电站 | 预计时间 | 推荐用途 |
|------|------|--------|--------|----------|----------|
| `test_alns_optimization_small.py` | 小 | 10 | 1 | 1-2分钟 | 快速验证和演示 |
| `test_alns_optimization_medium.py` | 中 | 30 | 2 | 3-5分钟 | 实际应用测试 |
| `test_alns_optimization_large.py` | 大 | 50 | 3 | 10-30分钟 | 可扩展性验证 |

---

## 🎯 测试目标

每个测试文件都会展示：

### 1. 优化前后对比
- **初始解**：使用Greedy算法快速构建
- **优化解**：经过ALNS多次迭代优化

### 2. 详细指标
- 总距离（米）
- 总充电量（kWh）
- 总时间（秒/分钟）
- 总延迟（秒）
- 充电站访问次数
- 总成本

### 3. 充电策略对比
- **FR** (Full Recharge)：完全充电
- **PR-Fixed**：固定比例局部充电
- **PR-Minimal**：最小充电策略

### 4. 改进分析
- 距离改进百分比
- 充电量改进百分比
- 总成本改进百分比
- 优化耗时

---

## 🚀 快速开始

### 小规模测试（推荐入门）
```bash
python tests/optimization/test_alns_optimization_small.py
```

**输出示例**：
```
======================================================================
小规模场景ALNS优化效果测试
======================================================================

场景配置:
  任务数: 10个
  充电站: 1个
  仓库范围: 60m × 60m
  车辆容量: 150kg
  电池容量: 12kWh

======================================================================
充电策略: 完全充电 (FR)
======================================================================

步骤1: 创建初始解（Greedy插入）
  构建时间: 0.25秒

初始解:
  服务任务数: 10/10
  总距离: 856.32m
  总充电量: 0.85kWh
  总时间: 720.45s (12.0分钟)
  总延迟: 0.00s
  充电站访问: 0次
  总成本: 857.02

步骤2: ALNS优化（50次迭代）
  优化时间: 15.32秒

优化后:
  服务任务数: 10/10
  总距离: 782.15m
  总充电量: 0.78kWh
  总时间: 658.23s (11.0分钟)
  总延迟: 0.00s
  充电站访问: 0次
  总成本: 782.62

步骤3: 优化改进分析
  距离改进: 74.17m (8.7%)
  成本改进: 74.40 (8.7%)
  总耗时: 15.57秒

...

======================================================================
最终对比总结
======================================================================

策略                 初始成本       优化成本       改进          改进率
----------------------------------------------------------------------
完全充电 (FR)        857.02        782.62        74.40         8.7%
固定50% (PR-Fixed)   858.35        785.22        73.13         8.5%
最小充电 (PR-Minimal) 859.12        784.05        75.07         8.7%

推荐策略: 完全充电 (FR)
  最优成本: 782.62
  总改进: 74.40 (8.7%)
```

---

### 中规模测试
```bash
python tests/optimization/test_alns_optimization_medium.py
```

**特点**：
- 30个任务
- 2个充电站
- 100次ALNS迭代
- 更真实的实际应用场景

---

### 大规模测试（需要耐心）
```bash
# ⚠️ 此测试可能需要10-30分钟
python tests/optimization/test_alns_optimization_large.py
```

**特点**：
- 50个任务
- 3个充电站
- 展示ALNS可扩展性
- 只测试两种有代表性的充电策略（加快速度）

---

## 📊 输出结构

每个测试都按以下结构输出：

```
1. 场景配置
   ├─ 任务数、充电站数
   ├─ 仓库范围
   └─ 车辆参数

2. 对每种充电策略：
   ├─ 步骤1: 构建初始解
   │   ├─ 构建时间
   │   └─ 初始解指标
   │
   ├─ 步骤2: ALNS优化
   │   ├─ 优化时间
   │   └─ 优化后指标
   │
   └─ 步骤3: 改进分析
       ├─ 距离改进
       ├─ 充电改进
       └─ 成本改进

3. 最终对比总结
   ├─ 成本对比表格
   ├─ 距离对比
   ├─ 充电量对比
   ├─ 充电站访问次数对比
   └─ 推荐策略
```

---

## 🔧 自定义测试

你可以修改测试参数来适应你的需求：

### 调整ALNS迭代次数
```python
# 在 test_optimization_with_strategy() 中
optimized_route = alns.optimize(initial_route, max_iterations=100)  # 修改这里
```

### 调整成本权重
```python
# 在创建ALNS时
cost_params=CostParameters(
    C_tr=1.0,      # 距离成本权重
    C_ch=0.6,      # 充电成本权重
    C_delay=2.0,   # 延迟惩罚权重
    C_time=0.1     # 时间成本权重
)
```

### 修改充电策略参数
```python
# PR-Fixed策略
PartialRechargeFixedStrategy(charge_ratio=0.5)  # 改为0.3或0.8

# PR-Minimal策略
PartialRechargeMinimalStrategy(safety_margin=0.1)  # 改为0.05或0.2
```

---

## 📈 性能基准

基于测试机器性能的预估（仅供参考）：

| 规模 | 构建初始解 | ALNS优化 | 总耗时 | 改进率 |
|-----|-----------|---------|--------|--------|
| 小（10任务） | <1秒 | 10-20秒 | ~20秒 | 5-10% |
| 中（30任务） | 1-3秒 | 30-90秒 | ~2分钟 | 8-15% |
| 大（50任务） | 5-10分钟 | 10-20分钟 | ~20分钟 | 10-20% |

---

## 💡 使用建议

### 对于演示
- 使用**小规模测试**，快速展示优化效果
- 关注成本改进百分比和优化时间

### 对于开发
- 使用**中规模测试**，验证算法改进
- 对比不同充电策略的实际效果

### 对于性能验证
- 使用**大规模测试**，验证可扩展性
- 分析每次迭代的平均时间
- 评估算法在实际规模下的表现

---

## 🎓 理解优化过程

### ALNS如何工作

1. **Destroy阶段**
   - 从当前解中移除部分任务
   - 使用random_removal或partial_removal

2. **Repair阶段**
   - 将移除的任务重新插入
   - 使用greedy_insertion或regret2_insertion
   - 检查容量、时间窗、能量约束

3. **接受准则**
   - 使用模拟退火接受新解
   - 允许暂时接受较差的解以跳出局部最优

4. **迭代改进**
   - 重复Destroy-Repair过程
   - 记录遇到的最优解

### 为什么需要优化

- **Greedy初始解**：快速但通常不是最优
- **ALNS优化**：通过迭代探索更好的解
- **典型改进**：5-20%的成本降低

---

## 📞 问题排查

### 测试运行很慢？
- **正常**：大规模测试需要较长时间
- **解决**：减少迭代次数或使用小规模测试

### 优化效果不明显？
- 检查成本权重设置
- 尝试增加迭代次数
- 调整充电策略参数

### 内存不足？
- 减少任务数量
- 使用小规模测试

---

## 📁 相关文件

- `../week3/` - 功能验证测试（不含优化对比）
- `../../docs/ARCHITECTURE.md` - 完整架构说明
- `../../src/planner/alns.py` - ALNS算法实现

---

*最后更新: 2024*
*用途: ALNS优化效果展示和性能验证*
