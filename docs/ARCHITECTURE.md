# R3 æ¡†æ¶æ¶æ„è¯´æ˜

## ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½

æœ¬æ¡†æ¶å®ç°**å¸¦å……ç”µç«™çš„ç”µåŠ¨AMRè·¯å¾„è§„åˆ’**ï¼Œä½¿ç”¨**ALNSå…ƒå¯å‘å¼ç®—æ³•**è¿›è¡Œå¤šç›®æ ‡ä¼˜åŒ–ã€‚

### ä¼˜åŒ–ç›®æ ‡
æœ€å°åŒ–ï¼š`è·ç¦»æˆæœ¬ + å……ç”µæˆæœ¬ + è¿Ÿåˆ°æƒ©ç½š + å†²çªç­‰å¾…æƒ©ç½š + æ‹’å•æƒ©ç½š + é©»ç•™æƒ©ç½š`ï¼ˆå†²çªç­‰å¾…ä»¥ w æ±‡èšèŠ‚ç‚¹/è¾¹å»¶è¿Ÿï¼‰

### æ ¸å¿ƒçº¦æŸ
- âœ… **å®¹é‡çº¦æŸ**ï¼šè½½é‡ä¸è¶…è¿‡è½¦è¾†å®¹é‡
- âœ… **æ—¶é—´çª—çº¦æŸ**ï¼šç¡¬æ—¶é—´çª—ï¼ˆæ‹’ç»ï¼‰/ è½¯æ—¶é—´çª—ï¼ˆæƒ©ç½šï¼‰
- âœ… **èƒ½é‡çº¦æŸ**ï¼šç”µæ± ä¸è€—å°½
- âœ… **é¡ºåºçº¦æŸ**ï¼šPickupå…ˆäºDelivery
- âœ… **å……ç”µç«™çº¦æŸ**ï¼šåŠ¨æ€æ’å…¥/ç§»é™¤
- âœ… **å†²çªè§„é¿**ï¼šèŠ‚ç‚¹/è¾¹å¤´è·çº¦æŸï¼Œå†²çªç­‰å¾… w å…¥æˆæœ¬ï¼ˆedge wait ä»…ä½œä¸‹ç•Œï¼‰
- âœ… **Scenario/Epoch å¯¹é½**ï¼šScenario åŒ…å«é‡Šæ”¾æ—¶åˆ»ä¸å¯é€‰æ‰°åŠ¨ï¼›Epoch ä¸ºäº‹ä»¶è§¦å‘ï¼ˆä»»åŠ¡åˆ°è¾¾/ç©ºé—²/å……ç”µå®Œæˆ/SOCè¿‡ä½/æ­»é”é£é™©ï¼‰
- âœ… **æ‹’å•å†³ç­–**ï¼šæœªæ¥å—ä»»åŠ¡è®¡å…¥æƒ©ç½š

---

## ğŸ—ï¸ æ¨¡å—ç»“æ„

```
src/
â”œâ”€â”€ core/               # æ ¸å¿ƒæ•°æ®ç»“æ„
â”‚   â”œâ”€â”€ node.py        # èŠ‚ç‚¹å®šä¹‰ï¼ˆDepot/Task/Chargingï¼‰
â”‚   â”œâ”€â”€ task.py        # ä»»åŠ¡å’Œä»»åŠ¡æ± 
â”‚   â”œâ”€â”€ route.py       # è·¯å¾„è¡¨ç¤ºå’Œå¯è¡Œæ€§æ£€æŸ¥
â”‚   â””â”€â”€ vehicle.py     # è½¦è¾†å±æ€§
â”‚
â”œâ”€â”€ physics/           # ç‰©ç†æ¨¡å‹
â”‚   â”œâ”€â”€ distance.py    # è·ç¦»è®¡ç®—
â”‚   â”œâ”€â”€ energy.py      # èƒ½è€—å’Œå……ç”µæ¨¡å‹
â”‚   â””â”€â”€ time.py        # æ—¶é—´çª—å’Œå»¶è¿Ÿè®¡ç®—
â”‚
â”œâ”€â”€ planner/           # ä¼˜åŒ–ç®—æ³•
â”‚   â””â”€â”€ alns.py        # ALNSæ ¸å¿ƒç®—æ³•
â”‚
â””â”€â”€ strategy/          # å……ç”µç­–ç•¥
    â””â”€â”€ charging_strategies.py  # FR/PR-Fixed/PR-Minimal
```

---

## ğŸ”§ ALNSç®—æ³•å®ç°

### Destroyç®—å­
- **random_removal**: éšæœºç§»é™¤qä¸ªä»»åŠ¡
- **partial_removal**ï¼ˆä»“å‚¨åœºæ™¯è¿­ä»£ï¼‰: åªç§»é™¤deliveryèŠ‚ç‚¹ï¼Œä¿ç•™pickup

### Repairç®—å­
- **greedy_insertion**: è´ªå¿ƒæ’å…¥ï¼ˆæœ€å°æˆæœ¬ï¼‰
- **regret2_insertion**: Regret-2æ’å…¥ï¼ˆæœ€å¤§é—æ†¾å€¼ï¼‰
- **random_insertion**: éšæœºæ’å…¥

### Local Search
- **pair_exchange**ï¼ˆä»“å‚¨åœºæ™¯è¿­ä»£ï¼‰: äº¤æ¢ä¸¤ä¸ªä»»åŠ¡ä½ç½®

### çº¦æŸæ£€æŸ¥ï¼ˆRepairé˜¶æ®µï¼‰
```python
for æ¯ä¸ªæ’å…¥ä½ç½®:
    â‘  å®¹é‡å¯è¡Œæ€§æ£€æŸ¥           â†’ ä¸å¯è¡Œåˆ™è·³è¿‡
    â‘¡ æ—¶é—´çª—å¯è¡Œæ€§æ£€æŸ¥         â†’ ç¡¬çº¦æŸè¿ååˆ™è·³è¿‡
    â‘¢ èƒ½é‡å¯è¡Œæ€§æ£€æŸ¥           â†’ ä¸å¯è¡Œåˆ™æ’å…¥å……ç”µç«™
    â‘£ è®¡ç®—æˆæœ¬ï¼ˆè·ç¦»+å……ç”µ+è¿Ÿåˆ°+å†²çªç­‰å¾…+æ‹’å•+é©»ç•™ï¼‰
    â‘¤ é€‰æ‹©æœ€ä¼˜ä½ç½®
```

---

## âš¡ å……ç”µç­–ç•¥

### 1. Full Recharge (FR)
- **ç­–ç•¥**: æ¯æ¬¡å……æ»¡100%
- **ä¼˜ç‚¹**: å……ç”µæ¬¡æ•°å°‘
- **ç¼ºç‚¹**: å……ç”µæ—¶é—´é•¿
- **é€‚ç”¨**: å……ç”µç«™ç¨€ç–åœºæ™¯

### 2. Partial Recharge Fixed (PR-Fixed)
- **ç­–ç•¥**: å……åˆ°å›ºå®šç™¾åˆ†æ¯”ï¼ˆå¦‚50%ï¼‰
- **ä¼˜ç‚¹**: å……ç”µæ—¶é—´å›ºå®šä¸”çŸ­
- **ç¼ºç‚¹**: éœ€è¦æ›´é¢‘ç¹å……ç”µ
- **é€‚ç”¨**: å……ç”µç«™å¯†é›†åœºæ™¯

### 3. Partial Recharge Minimal (PR-Minimal)
- **ç­–ç•¥**: åªå……å¤Ÿç”¨çš„ç”µé‡ + å®‰å…¨ä½™é‡
- **ä¼˜ç‚¹**: å……ç”µæ—¶é—´æœ€çŸ­
- **ç¼ºç‚¹**: éœ€è¦å‡†ç¡®èƒ½é‡é¢„æµ‹
- **é€‚ç”¨**: å·²çŸ¥è·¯å¾„çš„é™æ€è§„åˆ’

---

## â° æ—¶é—´çª—çº¦æŸ

### ç¡¬æ—¶é—´çª— (HARD)
```python
TimeWindow(earliest=100, latest=200, window_type=TimeWindowType.HARD)
```
- **è¿å**: ç«‹å³æ‹’ç»è¯¥æ’å…¥ä½ç½®
- **æˆæœ¬**: æ— ç©·å¤§ï¼ˆä¸å¯è¡Œï¼‰
- **é€‚ç”¨**: åŒ»ç–—ç´§æ€¥é…é€ã€æ³•å¾‹æˆªæ­¢æ—¶é—´

### è½¯æ—¶é—´çª— (SOFT)
```python
TimeWindow(earliest=100, latest=200, window_type=TimeWindowType.SOFT)
```
- **è¿å**: å…è®¸ä½†å¢åŠ å»¶è¿Ÿæˆæœ¬
- **æˆæœ¬**: `å»¶è¿Ÿæ—¶é—´ Ã— C_delay`
- **é€‚ç”¨**: æ™®é€šå¿«é€’ã€éç´§æ€¥ä»»åŠ¡

---

## ğŸ“Š æµ‹è¯•è§„æ¨¡

| è§„æ¨¡ | ä»»åŠ¡æ•° | å……ç”µç«™ | æµ‹è¯•æ–‡ä»¶ |
|-----|-------|-------|---------|
| **å°** | 5-10 | 0-1 | `test_regression_small_scale.py` |
| **ä¸­** | 20-30 | 2 | `test_regression_medium_scale.py` |
| **å¤§** | 50-100 | 3-5 | `test_regression_large_scale.py` |

---

## ğŸ¯ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ç¤ºä¾‹
```python
from planner.alns import MinimalALNS, CostParameters
from strategy.charging_strategies import PartialRechargeMinimalStrategy

# åˆ›å»ºALNSä¼˜åŒ–å™¨
alns = MinimalALNS(
    distance_matrix=distance_matrix,
    task_pool=task_pool,
    repair_mode='regret2',
    cost_params=CostParameters(
        C_tr=1.0,      # è·ç¦»æˆæœ¬
        C_ch=0.6,      # å……ç”µæˆæœ¬
        C_delay=2.0    # å»¶è¿Ÿæƒ©ç½š
    ),
    charging_strategy=PartialRechargeMinimalStrategy(safety_margin=0.1)
)
alns.vehicle = vehicle
alns.energy_config = energy_config

# ä¼˜åŒ–
initial_route = ... # åˆå§‹è§£
optimized_route = alns.optimize(initial_route, max_iterations=100)
```

### æ·»åŠ æ—¶é—´çª—
```python
from physics.time import TimeWindow, TimeWindowType

pickup, delivery = create_task_node_pair(
    task_id=1,
    pickup_id=1,
    delivery_id=2,
    pickup_coords=(10, 0),
    delivery_coords=(10, 10),
    demand=20.0,
    # ç¡¬æ—¶é—´çª—
    pickup_time_window=TimeWindow(100, 200, TimeWindowType.HARD),
    # è½¯æ—¶é—´çª—
    delivery_time_window=TimeWindow(150, 250, TimeWindowType.SOFT)
)
```

---

## ğŸ“ˆ æˆæœ¬å‡½æ•°

```python
æ€»æˆæœ¬ = è·ç¦»æˆæœ¬ + å……ç”µæˆæœ¬ + è¿Ÿåˆ°æˆæœ¬ + å†²çªç­‰å¾…æˆæœ¬ + æ‹’å•æˆæœ¬ + é©»ç•™æˆæœ¬

å…¶ä¸­:
  è·ç¦»æˆæœ¬ = Î£è·ç¦» Ã— C_tr
  å……ç”µæˆæœ¬ = Î£å……ç”µé‡ Ã— C_ch
  å»¶è¿Ÿæˆæœ¬ = Î£å»¶è¿Ÿ Ã— C_delay  (æ—¶é—´çª—è¿å)
  å†²çªç­‰å¾…æˆæœ¬ = Î£ w_i Ã— C_conflictï¼ˆw æ±‡èšèŠ‚ç‚¹/è¾¹å»¶è¿Ÿï¼‰
  æ‹’å•æˆæœ¬ = Î£æœªæ¥å—ä»»åŠ¡ Ã— C_missing_task
  é©»ç•™æˆæœ¬ = Î£é©»ç•™ Ã— C_standby
```

---

## ğŸ“Œ MIP åŸºå‡†ä¸åˆ›æ–°ç‚¹

- **è§„åˆ™åº“ + RL é€‰æ‹©**ï¼šå°†åœ¨çº¿è°ƒåº¦å»ºæ¨¡ä¸ºè§„åˆ™é€‰æ‹©çš„è¶…å¯å‘å¼ï¼ŒRL åœ¨çº¿è¾“å‡ºè§„åˆ™ç»„åˆã€‚
- **å¯å­¦ä¹ éƒ¨åˆ†å……ç”µ**ï¼šå¯¹å……ç”µæ·±åº¦ç¦»æ•£åŒ–ï¼Œå…¼å®¹ç­–ç•¥å­¦ä¹ ä¸å¯¹ç…§åŸºå‡†ã€‚
- **å†²çªè§„é¿å®‰å…¨å±è”½**ï¼šå¤´è·çº¦æŸç¡®ä¿ collision-awareï¼Œå†²çªç­‰å¾… w è¿›å…¥ç›®æ ‡å‡½æ•°ã€‚
- **MIP åŸºå‡†æ¨¡å‹**ï¼šç”¨äºå°è§„æ¨¡æœ€ä¼˜/ä¸‹ç•Œå¯¹ç…§ï¼Œè¯¦è§ `docs/MIP_BASELINE_MODEL.md`ã€‚

---

## âœ… èƒ½åŠ›æ¦‚è§ˆ

- ğŸ” è‡ªé€‚åº”Destroy/Repairç®—å­ç»„åˆ
- ğŸ”‹ èƒ½é‡çº¦æŸä¸å¤šç§å……ç”µç­–ç•¥è”åŠ¨
- â±ï¸ æ—¶é—´çª—ã€å®¹é‡ä¸é¡ºåºå¤šé‡çº¦æŸ
- ğŸ“‰ å¤šç›®æ ‡æˆæœ¬è¯„ä¼°ï¼ˆè·ç¦»/æ—¶é—´/å……ç”µ/å»¶è¿Ÿï¼‰

----

## ğŸš§ åç»­æ–¹å‘

1. å¯ç”¨ç”µé‡ä¸´ç•Œå€¼æœºåˆ¶ï¼ˆ`EnergyConfig.critical_battery_threshold`ï¼‰
2. æ‰©å±•è‡³å¤šè½¦è¾†è°ƒåº¦
3. æ”¯æŒåŠ¨æ€ä»»åŠ¡åˆ°è¾¾

----

## ğŸ“ å…³é”®æ–‡ä»¶

- `src/planner/alns.py` â€” ALNSä¸»å¾ªç¯ä¸ç®—å­å®ç°
- `src/planner/operators.py` â€” ç®—å­é€‰æ‹©ä¸æƒé‡æ›´æ–°å·¥å…·
- `src/baselines/mip/model.py` â€” MIPåŸºå‡†æ¨¡å‹ç»“æ„ï¼ˆè§„åˆ™é€‰æ‹©ä¸å†²çª/å……ç”µå¯¹ç…§ï¼‰
- `tests/warehouse_regression/*.py` â€” æ ¸å¿ƒæµç¨‹å›å½’æµ‹è¯•
- `tests/charging/test_strategy_comparison.py` â€” å……ç”µç­–ç•¥å¯¹æ¯”

----

## ğŸ”¬ è¿è¡Œæµ‹è¯•

```bash
# æ ¸å¿ƒå›å½’ï¼ˆæ¨èï¼‰
python tests/warehouse_regression/test_integrated_features.py

# æŒ‰è§„æ¨¡æ‹†åˆ†
python tests/warehouse_regression/test_regression_small_scale.py
python tests/warehouse_regression/test_regression_medium_scale.py
python tests/warehouse_regression/test_regression_large_scale.py

# ç­–ç•¥å¯¹æ¯”
python tests/charging/test_strategy_comparison.py
```

----

## ğŸ—“ï¸ å¼€å‘é‡Œç¨‹ç¢‘

| é˜¶æ®µ | é‡ç‚¹ | çŠ¶æ€ |
|------|------|------|
| Phase 1 | æ„å»ºALNSæ ¸å¿ƒã€Destroy/Repairç®—å­ | âœ… å®Œæˆ |
| Phase 2 | é›†æˆå……ç”µç­–ç•¥ä¸èƒ½é‡çº¦æŸ | âœ… å®Œæˆ |
| Phase 3 | æ—¶é—´çª—ã€å®¹é‡ã€å¤šç›®æ ‡æˆæœ¬è”è°ƒ | âœ… å®Œæˆ |
| æœªæ¥ | ç”µé‡ä¸´ç•Œå€¼ã€å¤šè½¦è¾†ã€åŠ¨æ€ä»»åŠ¡ | ğŸš§ è§„åˆ’ä¸­ |

----

*æœ€åæ›´æ–°ï¼šPhase 3 å®Œæˆ*
*ç‰ˆæœ¬ï¼š1.1*
